name: Build latest usteer for N60pro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TARGET: "aarch64_cortex-a53"
      PROFILE: "mt7986"
    steps:
      - name: Checkout ImmortalWrt SDK
        run: |
          wget -q https://github.com/immortalwrt/immortalwrt/releases/download/v24.10.4/ImmortalWrt-SDK-24.10.4-aarch64_cortex-a53.tar.xz
          tar -xf ImmortalWrt-SDK-24.10.4-aarch64_cortex-a53.tar.xz
          mv ImmortalWrt-SDK-24.10.4-aarch64_cortex-a53 sdk

      - name: Setup environment
        run: |
          cd sdk
          export STAGING_DIR=$(pwd)/staging_dir
          export PATH=$STAGING_DIR/toolchain-aarch64_cortex-a53_gcc-13.3.0_musl/bin:$PATH
          export TERM=dumb

      - name: Clone latest usteer package
        run: |
          cd sdk/package
          rm -rf usteer
          git clone git://git.openwrt.org/project/usteer.git

      - name: Configure minimal build for usteer
        run: |
          cd sdk
          export TERM=dumb
          cp defconfig .config
          # 设置目标架构和设备
          echo "CONFIG_TARGET_aarch64_cortex-a53=y" >> .config
          echo "CONFIG_PACKAGE_usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-usteer-zh-cn=y" >> .config
          make oldconfig

      - name: Compile usteer only
        run: |
          cd sdk
          export TERM=dumb
          # 多线程编译，加快速度
          make -j$(nproc) package/usteer/{compile,install} V=s

      - name: Upload IPK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: usteer-ipk
          path: |
            sdk/bin/packages/*/base/usteer_*.ipk
            sdk/bin/packages/*/luci/luci-app-usteer_*.ipk
            sdk/bin/packages/*/luci/luci-i18n-usteer-zh-cn_*.ipk
          retention-days: 7
