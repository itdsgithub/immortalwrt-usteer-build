name: Build latest usteer for ImmortalWrt 24.10.4

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TARGET: "aarch64_cortex-a53"   # N60 Pro CPU 架构
      PROFILE: "mt7986"              # 路由器型号
    steps:
      - name: Checkout ImmortalWrt 24.10.4
        uses: actions/checkout@v3
        with:
          repository: immortalwrt/immortalwrt
          ref: v24.10.4
          path: immortalwrt

      - name: Setup dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev zlib1g-dev gawk git ccache gettext libssl-dev xsltproc unzip python3 python3-distutils wget subversion

      - name: Update feeds
        run: |
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clone latest usteer package
        run: |
          cd immortalwrt/package
          rm -rf usteer
          git clone git://git.openwrt.org/project/usteer.git

      - name: Configure minimal build for usteer
        run: |
          cd immortalwrt
          # 默认配置
          make defconfig
          # 设置目标架构
          sed -i 's/TARGET_ARCH:=x86_64/TARGET_ARCH:=aarch64/' .config
          sed -i 's/TARGET_SUBTARGET:=x86_64/TARGET_SUBTARGET:=cortex-a53/' .config
          # 启用 usteer、LuCI 和中文语言包
          echo "CONFIG_PACKAGE_usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-usteer-zh-cn=y" >> .config
          # 禁用其它包以加快编译
          sed -i '/CONFIG_PACKAGE_/!d' .config

      - name: Build toolchain
        run: |
          cd immortalwrt
          make toolchain/install -j$(nproc)

      - name: Compile usteer only
        run: |
          cd immortalwrt
          make -j$(nproc) package/usteer/{compile,install} V=s

      - name: Upload IPK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: usteer-ipk
          path: |
            immortalwrt/bin/packages/*/base/usteer_*.ipk
            immortalwrt/bin/packages/*/luci/luci-app-usteer_*.ipk
            immortalwrt/bin/packages/*/luci/luci-i18n-usteer-zh-cn_*.ipk
          retention-days: 7
