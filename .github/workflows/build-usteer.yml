name: Build Latest usteer + LuCI for N60Pro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev gawk gettext unzip python3 wget git

      - name: Download ImmortalWrt SDK
        run: |
          wget -O sdk.tar.xz https://mirrors.tuna.tsinghua.edu.cn/openwrt/releases/24.10.4/targets/mediatek/filogic/ImmortalWrt-SDK-24.10.4-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar -xf sdk.tar.xz
          SDK_DIR=$(find . -maxdepth 1 -type d -name "ImmortalWrt-SDK*")
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Update feeds
        run: |
          cd $SDK_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Replace usteer with newest source
        run: |
          cd $SDK_DIR/package/network/services
          rm -rf usteer
          git clone https://git.openwrt.org/project/usteer.git usteer

      - name: Replace luci-app-usteer (latest)
        run: |
          cd $SDK_DIR/feeds/luci/applications
          rm -rf luci-app-usteer
          git clone https://github.com/openwrt/luci.git /tmp/luci-temp
          mv /tmp/luci-temp/applications/luci-app-usteer .
          rm -rf /tmp/luci-temp

      - name: Build usteer + luci app + zh-cn language
        run: |
          cd $SDK_DIR
          # 启用三个包
          echo "CONFIG_PACKAGE_usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-usteer-zh-cn=y" >> .config
          make defconfig
          # 编译
          make package/usteer/compile -j$(nproc) V=s
          make package/luci-app-usteer/compile -j$(nproc) V=s
          make package/luci-i18n-usteer-zh-cn/compile -j$(nproc) V=s

      - name: Upload IPK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: usteer-ipk
          path: |
            ${{ env.SDK_DIR }}/bin/packages/*/*/usteer_*.ipk
            ${{ env.SDK_DIR }}/bin/packages/*/*/luci-app-usteer_*.ipk
            ${{ env.SDK_DIR }}/bin/packages/*/*/luci-i18n-usteer-zh-cn_*.ipk
          retention-days: 7
