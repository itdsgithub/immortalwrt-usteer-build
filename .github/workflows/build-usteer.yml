name: Build Latest usteer + LuCI for N60Pro (ImmortalWrt 24.10.4)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: "-j$(nproc)"   # 多线程加速

    steps:
      - name: Checkout ImmortalWrt
        uses: actions/checkout@v3
        with:
          repository: immortalwrt/immortalwrt
          ref: v24.10.4
          path: immortalwrt

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev gawk gettext unzip python3 wget git subversion flex bison ccache

      - name: Update feeds
        run: |
          cd immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Replace usteer with latest source
        run: |
          cd immortalwrt/package/network/services
          rm -rf usteer
          git clone git://git.openwrt.org/project/usteer.git usteer

      - name: Replace luci-app-usteer (latest)
        run: |
          cd immortalwrt/feeds/luci/applications
          rm -rf luci-app-usteer
          git clone https://github.com/openwrt/luci.git luci-temp
          mv luci-temp/applications/luci-app-usteer .
          rm -rf luci-temp

      - name: Configure build non-interactively
        run: |
          cd immortalwrt
          # 确保 .config 文件存在
          touch .config
          # 启用 usteer 主程序、LuCI 和中文语言包
          echo "CONFIG_PACKAGE_usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-usteer=y" >> .config
          echo "CONFIG_PACKAGE_luci-i18n-usteer-zh-cn=y" >> .config
          # 避免 menuconfig 交互错误
          make defconfig

      - name: Compile packages
        run: |
          cd immortalwrt
          make package/usteer/compile V=s
          make package/luci-app-usteer/compile V=s
          make package/luci-i18n-usteer-zh-cn/compile V=s

      - name: Upload IPK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: usteer-ipk
          path: |
            immortalwrt/bin/packages/*/*/usteer*.ipk
            immortalwrt/bin/packages/*/*/luci-app-usteer*.ipk
            immortalwrt/bin/packages/*/*/luci-i18n-usteer-zh-cn*.ipk
